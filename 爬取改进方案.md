# 政策数据爬取改进方案

## 一、核心问题分析

### 当前数据的主要缺陷

| 问题类型 | 影响 | 严重程度 |
|----------|------|----------|
| 缺失发文字号 | 无法精确定位政策 | 🔴 高 |
| 缺失发布日期 | 无法判断有效期 | 🔴 高 |
| 缺失失效日期 | 可能使用过期政策 | 🔴 高 |
| 内容不够详细 | 答案质量不足 | 🟡 中 |
| 缺失地方政策 | 地区差异无法覆盖 | 🟡 中 |

---

## 二、数据采集标准

### 2.1 必需字段标准

```
核心标识字段：
├── policy_id: 唯一ID（由"来源+年份+序号"组成）
├── document_number: 发文字号（必需）
├── title: 完整标题（必需）
└── source: 发布机关（必需）

时效性字段：
├── publish_date: 发布日期（必需）
├── effective_date: 生效日期（重要）
├── expiry_date: 失效日期（重要）
└── validity_status: 有效状态（必需）

内容字段：
├── content_full: 政策全文（必需，>500字）
├── content_type: 内容类型（原文/解读/问答）
├── tax_type: 税种分类（必需）
└── region: 适用地域（必需）

元数据字段：
├── url: 原文链接（必需）
├── tags: 标签（可选）
└── crawled_at: 爬取时间（必需）
```

### 2.2 内容质量标准

```
┌─────────────────────────────────────────────────────┐
│                   内容质量等级                      │
├─────────────────────────────────────────────────────┤
│ Level 5 (优秀)                                     │
│ ├─ 完整政策原文 (>2000字)                         │
│ ├─ 官方解读文件                                    │
│ ├─ 相关问答/案例                                   │
│ └─ 明确的有效期                                    │
├─────────────────────────────────────────────────────┤
│ Level 4 (良好)                                     │
│ ├─ 完整政策原文 (>1000字)                         │
│ ├─ 官方解读文件                                    │
│ └─ 明确的有效期                                    │
├─────────────────────────────────────────────────────┤
│ Level 3 (合格)                                     │
│ ├─ 政策原文 (>500字)                               │
│ ├─ 有发文字号                                      │
│ └─ 有发布日期                                      │
├─────────────────────────────────────────────────────┤
│ Level 2 (基础)                                     │
│ ├─ 政策摘要 (>200字)                               │
│ └─ 有标题和来源                                    │
└─────────────────────────────────────────────────────┘

目标分布：
- Level 4-5: 60% (高质量政策)
- Level 3: 30% (完整政策)
- Level 2: 10% (辅助内容)
```

---

## 三、技术实现方案

### 3.1 爬虫架构优化

```
┌─────────────────────────────────────────────────────┐
│                   新爬虫架构                         │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌─────────────┐     ┌──────────────┐             │
│  │  URL种子池   │────▶│  URL调度器    │             │
│  └─────────────┘     └──────────────┘             │
│         │                   │                         │
│         ▼                   ▼                         │
│  ┌─────────────┐     ┌──────────────┐             │
│  │ 内容提取器   │     │  元数据提取器 │             │
│  │ (Playwright)│     │  (正则+XPath)  │             │
│  └─────────────┘     └──────────────┘             │
│         │                   │                         │
│         ▼                   ▼                         │
│  ┌─────────────┐     ┌──────────────┐             │
│  │  字段补全器  │────▶│  质量评分器   │             │
│  │ (智能识别)  │     │  (多维度)     │             │
│  └─────────────┘     └──────────────┘             │
│         │                   │                         │
│         ▼                   ▼                         │
│  ┌─────────────┐     ┌──────────────┐             │
│  │   去重器     │────▶│   存储模块    │             │
│  └─────────────┘     └──────────────┘             │
│                              │                         │
│                              ▼                         │
│                     ┌──────────────┐               │
│                     │  MongoDB     │               │
│                     │  + ChromaDB  │               │
│                     └──────────────┘               │
└─────────────────────────────────────────────────────┘
```

### 3.2 字段提取策略

#### 发文字号提取
```python
# 常见发文字号模式
PATTERNS = [
    r'(财政部|税务总局|国家税务总局)[\u3000\s]{0,5}公告[\d\u3000\s]{1,10}号',
    r'[一二三四五六七八九十\d]+年[\d\u3000\s]{1,5}号',
    r'税总[\d\u3000\s]{1,5}号',
    r'财[\d\u3000\s]{1,5}号',
    r'国税发[\d\u3000\s]{1,5}号',
]
```

#### 日期提取
```python
# 发布日期模式
DATE_PATTERNS = [
    r'(\d{4})[\u3000\-年](\d{1,2})[\u3000\-月](\d{1,2})',
    r'成文日期[：:]\s*(\d{4})[\u3000\-年](\d{1,2})[\u3000\-月](\d{1,2})',
    r'发布日期[：:]\s*(\d{4})[\u3000\-年](\d{1,2})[\u3000\-月](\d{1,2})',
]
```

#### 有效期提取
```python
# 有效期关键词
EXPIRY_KEYWORDS = {
    '执行期限': r'(执行|有效)(期限|期间)[：:]\s*(.*?)(?=。|，|$)',
    '至': r'(自|至|起)[\u3000\s]*(\d{4}年)(\d{1,2}月)(\d{1,2}日)',
    '截止': r'(截止|有效期至)[\u3000\s]*(\d{4}年)(\d{1,2}月)(\d{1,2}日)',
}
```

### 3.3 数据源优先级策略

```
优先级矩阵（按税种×数据源类型）：

                │政策原文│政策解读│热点问答│执行口径│
────────────────┼────────┼────────┼────────┼────────┤
总局          │  P0   │  P0    │  P0    │  P2    │
财政部        │  P0   │  P2    │  P2    │  P2    │
12366         │  P2   │  P1    │  P0    │  P2    │
北京          │  P1   │  P1    │  P1    │  P0    │
上海          │  P1   │  P1    │  P1    │  P0    │
广东/深圳     │  P1   │  P2    │  P2    │  P0    │
江苏/浙江     │  P2   │  P2    │  P2    │  P1    │
```

---

## 四、实施路线图

### 阶段一：核心数据源爬取（1-2周）

```
目标：覆盖总局三大税种政策原文+解读

数据源：
✓ 国家税务总局政策法规库（全量）
✓ 国家税务总局政策解读（全量）
✓ 12366热点问题（全量）
✓ 财政部财税文件（全量）

预期产出：
- 政策原文：~3000条
- 政策解读：~1000条
- 热点问答：~2000条
- 质量要求：Level 3以上≥80%
```

### 阶段二：发达地区政策（2-3周）

```
目标：覆盖北京、上海、广东、深圳、江苏、浙江

数据源：
✓ 六个发达省市税务局政策+解读
✓ 地方执行口径
✓ 地方热点问答

预期产出：
- 地方政策：~3000条
- 地方解读：~1000条
- 质量要求：Level 3以上≥70%
```

### 阶段三：增量更新机制（持续）

```
目标：建立定时更新机制

机制：
├── 每日增量爬取新政策
├── 每周更新政策解读
├── 每月检查政策失效状态
└── 每季度质量审计

技术实现：
├── Crontab定时任务
├── 基于URL的增量检测
├── 政策失效自动标记
└── 数据质量监控告警
```

---

## 五、质量保证机制

### 5.1 自动化质量检查

```python
def quality_check(doc):
    """数据质量评分"""
    score = 0

    # 必需字段检查 (30分)
    if doc.get('document_number'): score += 10
    if doc.get('publish_date'): score += 10
    if doc.get('title') and len(doc['title']) > 10: score += 10

    # 内容质量检查 (40分)
    content = doc.get('content', '')
    if len(content) > 500: score += 10
    if len(content) > 1000: score += 10
    if '解读' in doc.get('title', '') or '问答' in doc.get('title', ''): score += 10
    if doc.get('validity_status'): score += 10

    # 时效性检查 (20分)
    if doc.get('effective_date'): score += 10
    if doc.get('expiry_date'): score += 10

    # 完整性检查 (10分)
    if doc.get('tax_type') and doc['tax_type'] != ['其他']: score += 5
    if doc.get('source'): score += 5

    # 等级评定
    if score >= 90: return 'Level 5'
    if score >= 75: return 'Level 4'
    if score >= 60: return 'Level 3'
    if score >= 40: return 'Level 2'
    return 'Level 1'
```

### 5.2 数据验证规则

```
验证规则清单：
□ 标题非空且长度>10字符
□ 发文字号符合规范
□ 发布日期在合理范围内(2015-当前年份)
□ 内容长度>200字符
□ 税种不为空或'其他'
□ URL可访问
□ policy_id唯一
□ 与已有数据查重
```

---

## 六、风险控制

### 6.1 反爬虫应对

| 风险 | 应对措施 |
|------|----------|
| IP封禁 | 使用代理IP池、降低请求频率 |
| 验证码 | Playwright自动化处理 |
| 动态加载 | Playwright等待页面渲染 |
| 403/429 | 指数退避重试 |

### 6.2 数据质量风险

| 风险 | 应对措施 |
|------|----------|
| 重复数据 | policy_id唯一约束 + 内容指纹去重 |
| 过期政策 | 定期爬取政策失效公告 + 有效期字段 |
| 解读错误 | 只爬取官方解读，标注来源 |

---

## 七、下一步行动

### 立即执行

1. **优化现有Playwright爬虫**
   - 增加发文字号提取
   - 增加日期提取
   - 增加有效期提取

2. **爬取12366热点问题**
   - 结构化问答对
   - 标注问题类型

3. **爬取财政部财税文件**
   - 增值税、所得税源头政策

### 中期规划

1. **开发地方税务局爬虫**
2. **建立增量更新机制**
3. **完善数据质量评分系统**

需要我开始实施这个改进方案吗？
