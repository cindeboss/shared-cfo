<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…±äº«CFO - æ•°æ®æŸ¥è¯¢ç›‘æ§å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 0.9em;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 120px;
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .content-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: none;
        }

        .content-panel.active {
            display: block;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box input,
        .search-box select {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            flex: 1;
            min-width: 200px;
        }

        .search-box input:focus,
        .search-box select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .list-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .list-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }

        .list-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .list-item h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .list-item .meta {
            color: #666;
            font-size: 0.9em;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .badge-level-L1 { background: #ff6b6b; color: white; }
        .badge-level-L2 { background: #feca57; color: #333; }
        .badge-level-L3 { background: #48dbfb; color: white; }
        .badge-level-L4 { background: #1dd1a1; color: white; }

        .detail-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .detail-panel h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 500;
            color: #667eea;
            min-width: 150px;
        }

        .detail-value {
            color: #333;
            flex: 1;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .monitor-chart {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bar-label {
            min-width: 150px;
            color: #666;
        }

        .bar-fill {
            flex: 1;
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 30px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 500;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .quality-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .quality-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .quality-item.good {
            border-left: 4px solid #1dd1a1;
        }

        .quality-item.warning {
            border-left: 4px solid #feca57;
        }

        .quality-item.error {
            border-left: 4px solid #ff6b6b;
        }

        .content-text {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ å…±äº«CFO</h1>
            <p>ç¨åŠ¡æ”¿ç­–æ•°æ®æŸ¥è¯¢ä¸ç›‘æ§ç³»ç»Ÿ</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showPanel('stats')">ğŸ“Š æ•°æ®ç»Ÿè®¡</button>
            <button class="nav-tab" onclick="showPanel('search')">ğŸ” æœç´¢æ”¿ç­–</button>
            <button class="nav-tab" onclick="showPanel('recent')">ğŸ“‹ æœ€è¿‘æ”¿ç­–</button>
            <button class="nav-tab" onclick="showPanel('monitor')">ğŸ“ˆ çˆ¬è™«ç›‘æ§</button>
        </div>

        <!-- æ•°æ®ç»Ÿè®¡é¢æ¿ -->
        <div id="panel-stats" class="content-panel active">
            <h2 style="margin-bottom: 20px;">æ•°æ®ç»Ÿè®¡</h2>
            <div id="stats-content"></div>
        </div>

        <!-- æœç´¢é¢æ¿ -->
        <div id="panel-search" class="content-panel">
            <h2 style="margin-bottom: 20px;">æœç´¢æ”¿ç­–</h2>
            <div class="search-box">
                <input type="text" id="search-keyword" placeholder="æœç´¢å…³é”®è¯...">
                <select id="search-level">
                    <option value="">æ‰€æœ‰å±‚çº§</option>
                    <option value="L1">L1 - æ³•å¾‹</option>
                    <option value="L2">L2 - è¡Œæ”¿æ³•è§„</option>
                    <option value="L3">L3 - è§„èŒƒæ€§æ–‡ä»¶</option>
                    <option value="L4">L4 - æ”¿ç­–è§£è¯»</option>
                </select>
                <select id="search-source">
                    <option value="">æ‰€æœ‰æ¥æº</option>
                    <option value="chinatax">å›½å®¶ç¨åŠ¡æ€»å±€</option>
                </select>
                <button class="btn btn-primary" onclick="searchPolicies()">æœç´¢</button>
            </div>
            <div id="search-results"></div>
        </div>

        <!-- æœ€è¿‘æ”¿ç­–é¢æ¿ -->
        <div id="panel-recent" class="content-panel">
            <h2 style="margin-bottom: 20px;">æœ€è¿‘æ”¿ç­–</h2>
            <button class="btn btn-primary" onclick="loadRecent()" style="margin-bottom: 20px;">åˆ·æ–°åˆ—è¡¨</button>
            <div id="recent-list"></div>
        </div>

        <!-- ç›‘æ§é¢æ¿ -->
        <div id="panel-monitor" class="content-panel">
            <h2 style="margin-bottom: 20px;">çˆ¬è™«ç›‘æ§</h2>
            <div style="margin-bottom: 20px;">
                <label>æ—¶é—´èŒƒå›´: </label>
                <select id="monitor-hours" onchange="loadMonitor()">
                    <option value="1">æœ€è¿‘ 1 å°æ—¶</option>
                    <option value="6">æœ€è¿‘ 6 å°æ—¶</option>
                    <option value="24" selected>æœ€è¿‘ 24 å°æ—¶</option>
                    <option value="72">æœ€è¿‘ 3 å¤©</option>
                    <option value="168">æœ€è¿‘ 7 å¤©</option>
                </select>
                <button class="btn btn-primary" onclick="loadMonitor()">åˆ·æ–°</button>
            </div>
            <div id="monitor-content"></div>
        </div>

        <!-- æ”¿ç­–è¯¦æƒ…é¢æ¿ -->
        <div id="panel-detail" class="content-panel" style="display: none;">
            <h2 style="margin-bottom: 20px;">æ”¿ç­–è¯¦æƒ…</h2>
            <button class="btn btn-secondary" onclick="hideDetail()" style="margin-bottom: 20px;">â† è¿”å›</button>
            <div id="detail-content"></div>
        </div>
    </div>

    <script>
        const API_BASE = '';

        function showPanel(panel) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`[onclick="showPanel('${panel}')"]`).classList.add('active');
            document.getElementById(`panel-${panel}`).classList.add('active');

            if (panel === 'stats') loadStats();
            if (panel === 'recent') loadRecent();
            if (panel === 'monitor') loadMonitor();
        }

        async function loadStats() {
            const content = document.getElementById('stats-content');
            content.innerHTML = '<div class="loading"><span class="spinner"></span></div>';

            try {
                const res = await fetch(`${API_BASE}/api/stats`);
                const data = await res.json();

                if (!data.success) throw new Error(data.error);

                const stats = data.data;
                content.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="value">${stats.total}</div>
                            <div class="label">æ€»æ”¿ç­–æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="value">${Object.keys(stats.by_source).length}</div>
                            <div class="label">æ•°æ®æ¥æº</div>
                        </div>
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 15px;">æŒ‰å±‚çº§ç»Ÿè®¡</h3>
                    <div class="bar-chart">
                        ${Object.entries(stats.by_level).map(([k, v]) => `
                            <div class="bar-item">
                                <span class="bar-label">${k || 'æœªçŸ¥'}</span>
                                <div class="bar-fill" style="width: ${(v / stats.total * 100) || 5}%">${v} æ¡</div>
                            </div>
                        `).join('')}
                    </div>

                    <h3 style="margin-top: 30px; margin-bottom: 15px;">æŒ‰æ¥æºç»Ÿè®¡</h3>
                    <div class="bar-chart">
                        ${Object.entries(stats.by_source).map(([k, v]) => `
                            <div class="bar-item">
                                <span class="bar-label">${k || 'æœªçŸ¥'}</span>
                                <div class="bar-fill" style="width: ${(v / stats.total * 100) || 5}%">${v} æ¡</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (e) {
                content.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${e.message}</div>`;
            }
        }

        async function searchPolicies() {
            const keyword = document.getElementById('search-keyword').value;
            const level = document.getElementById('search-level').value;
            const source = document.getElementById('search-source').value;
            const content = document.getElementById('search-results');

            content.innerHTML = '<div class="loading"><span class="spinner"></span></div>';

            try {
                const params = new URLSearchParams({ keyword, level, source, limit: 50 });
                const res = await fetch(`${API_BASE}/api/search?${params}`);
                const data = await res.json();

                if (!data.success) throw new Error(data.error);

                if (data.data.count === 0) {
                    content.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æœªæ‰¾åˆ°åŒ¹é…çš„æ”¿ç­–</p>';
                    return;
                }

                content.innerHTML = `
                    <p style="margin-bottom: 15px; color: #666;">æ‰¾åˆ° ${data.data.count} æ¡åŒ¹é…çš„æ”¿ç­–</p>
                    <div class="list-group">
                        ${data.data.policies.map(p => `
                            <div class="list-item" onclick="showDetail('${p.policy_id}')">
                                <h4>${p.title || 'N/A'}</h4>
                                <div class="meta">
                                    <span>æ¥æº: ${p.source || 'N/A'}</span>
                                    <span>å±‚çº§: <span class="badge badge-level-${p.level}">${p.level || 'N/A'}</span></span>
                                    <span>çˆ¬å–: ${p.crawled_at?.split('T')[0] || 'N/A'}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (e) {
                content.innerHTML = `<div class="error">æœç´¢å¤±è´¥: ${e.message}</div>`;
            }
        }

        async function loadRecent() {
            const content = document.getElementById('recent-list');
            content.innerHTML = '<div class="loading"><span class="spinner"></span></div>';

            try {
                const res = await fetch(`${API_BASE}/api/recent?limit=50`);
                const data = await res.json();

                if (!data.success) throw new Error(data.error);

                content.innerHTML = `
                    <p style="margin-bottom: 15px; color: #666;">æœ€è¿‘ ${data.data.count} æ¡æ”¿ç­–</p>
                    <div class="list-group">
                        ${data.data.policies.map(p => `
                            <div class="list-item" onclick="showDetail('${p.policy_id}')">
                                <h4>${p.title || 'N/A'}</h4>
                                <div class="meta">
                                    <span>æ¥æº: ${p.source || 'N/A'}</span>
                                    <span>å±‚çº§: <span class="badge badge-level-${p.level}">${p.level || 'N/A'}</span></span>
                                    <span>çˆ¬å–: ${p.crawled_at?.split('T')[0] || 'N/A'}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (e) {
                content.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${e.message}</div>`;
            }
        }

        async function loadMonitor() {
            const hours = document.getElementById('monitor-hours').value;
            const content = document.getElementById('monitor-content');
            content.innerHTML = '<div class="loading"><span class="spinner"></span></div>';

            try {
                const res = await fetch(`${API_BASE}/api/monitor?hours=${hours}`);
                const data = await res.json();

                if (!data.success) throw new Error(data.error);

                const m = data.data;
                content.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="value">${m.total_db}</div>
                            <div class="label">æ€»æ”¿ç­–æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="value">${m.total_recent}</div>
                            <div class="label">æœ€è¿‘${hours}å°æ—¶çˆ¬å–</div>
                        </div>
                    </div>

                    <div class="monitor-chart">
                        <h3>ğŸ“Š çˆ¬å–è¶‹åŠ¿</h3>
                        <div class="bar-chart">
                            ${Object.entries(m.hourly_stats).slice(-10).map(([k, v]) => `
                                <div class="bar-item">
                                    <span class="bar-label">${k.split(' ')[1]}</span>
                                    <div class="bar-fill" style="width: ${Math.max(v / Math.max(...Object.values(m.hourly_stats)) * 100, 5)}%">${v} æ¡</div>
                                </div>
                            `).join('') || '<p style="color: #999;">æš‚æ— æ•°æ®</p>'}
                        </div>
                    </div>

                    <div class="quality-grid">
                        <div class="quality-item ${m.quality_issues.missing_title === 0 ? 'good' : 'error'}">
                            <div style="font-size: 2em; font-weight: bold;">${m.quality_issues.missing_title}</div>
                            <div>ç¼ºå°‘æ ‡é¢˜</div>
                        </div>
                        <div class="quality-item ${m.quality_issues.missing_url === 0 ? 'good' : 'error'}">
                            <div style="font-size: 2em; font-weight: bold;">${m.quality_issues.missing_url}</div>
                            <div>ç¼ºå°‘URL</div>
                        </div>
                        <div class="quality-item ${m.quality_issues.missing_level === 0 ? 'good' : 'warning'}">
                            <div style="font-size: 2em; font-weight: bold;">${m.quality_issues.missing_level}</div>
                            <div>ç¼ºå°‘å±‚çº§</div>
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                        <strong>ğŸ’¡ æç¤º:</strong> å®šæœŸæŸ¥çœ‹ç›‘æ§æ•°æ®ï¼ŒåŠæ—¶å‘ç°çˆ¬è™«é—®é¢˜
                    </div>
                `;
            } catch (e) {
                content.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${e.message}</div>`;
            }
        }

        async function showDetail(policyId) {
            document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
            document.getElementById('panel-detail').style.display = 'block';

            const content = document.getElementById('detail-content');
            content.innerHTML = '<div class="loading"><span class="spinner"></span></div>';

            try {
                const res = await fetch(`${API_BASE}/api/policy/${policyId}`);
                const data = await res.json();

                if (!data.success) throw new Error(data.error);

                const p = data.data;
                content.innerHTML = `
                    <div class="detail-panel">
                        <h3>${p.title || 'N/A'}</h3>

                        <div class="detail-row">
                            <span class="detail-label">Policy ID:</span>
                            <span class="detail-value">${p.policy_id || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">æ¥æº:</span>
                            <span class="detail-value">${p.source || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">å±‚çº§:</span>
                            <span class="detail-value"><span class="badge badge-level-${p.level}">${p.level || 'N/A'}</span></span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">åˆ†ç±»:</span>
                            <span class="detail-value">${p.category || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">å‘æ–‡å­—å·:</span>
                            <span class="detail-value">${p.document_number || 'N/A'}</span>
                        </div>
                        ${p.url ? `
                        <div class="detail-row">
                            <span class="detail-label">åŸæ–‡é“¾æ¥:</span>
                            <span class="detail-value"><a href="${p.url}" target="_blank">${p.url}</a></span>
                        </div>` : ''}
                        <div class="detail-row">
                            <span class="detail-label">çˆ¬å–æ—¶é—´:</span>
                            <span class="detail-value">${p.crawled_at || 'N/A'}</span>
                        </div>

                        ${p.content ? `
                        <div style="margin-top: 20px;">
                            <h4 style="margin-bottom: 10px;">æ­£æ–‡å†…å®¹</h4>
                            <div class="content-text">${p.content.substring(0, 3000)}${p.content.length > 3000 ? '\n\n... (å†…å®¹å·²æˆªæ–­)' : ''}</div>
                        </div>` : '<p style="margin-top: 20px; color: #999;">æš‚æ— æ­£æ–‡å†…å®¹</p>'}

                        <div style="margin-top: 20px;">
                            <a href="${API_BASE}/api/export?keyword=${encodeURIComponent(p.title || '')}&limit=1" download>
                                <button class="btn btn-primary">å¯¼å‡ºæ­¤æ”¿ç­–</button>
                            </a>
                        </div>
                    </div>
                `;
            } catch (e) {
                content.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${e.message}</div>`;
            }
        }

        function hideDetail() {
            document.getElementById('panel-detail').style.display = 'none';
            document.getElementById('panel-search').classList.add('active');
        }

        // åˆå§‹åŒ–åŠ è½½ç»Ÿè®¡æ•°æ®
        loadStats();
    </script>
</body>
</html>
