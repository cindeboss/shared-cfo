# 阿里云部署指南

## 部署架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        阿里云部署架构                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────┐      ┌──────────────┐      ┌─────────────┐  │
│   │   阿里云ECS  │ ───→ │  阿里云MongoDB │      │    Qdrant   │  │
│   │  (爬虫程序)  │      │   (数据存储)   │ ───→ │  (向量存储)  │  │
│   │  2核4G      │      │   1核2G 100GB │      │   云端版     │  │
│   └─────────────┘      └──────────────┘      └─────────────┘  │
│         │                     │                                 │
│         └─────────────────────┴─────────────────────────→      │
│                          │                                    │
│                    ┌──────▼───────┐                           │
│                    │ GLM-4 API    │                           │
│                    │ (智谱云)     │                           │
│                    └──────────────┘                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 一、购买阿里云资源

### 1.1 购买ECS服务器

**推荐配置（入门版）**：
- **实例规格**：ecs.t6-c1m2.large（2核4G）
- **操作系统**：Ubuntu 22.04 64位
- **网络类型**：专有网络VPC
- **公网带宽**：1Mbps（按使用量）
- **付费方式**：按量付费（约¥100/月）

**购买步骤**：
1. 登录阿里云控制台
2. 产品 → 弹性计算 → 云服务器ECS
3. 创建实例 → 选择配置
4. 确认订单并支付

### 1.2 购买MongoDB

**推荐配置（入门版）**：
- **版本**：4.4
- **规格**：1核2G 100GB
- **副本集**：单节点
- **付费方式**：按量付费（约¥200/月）

**购买步骤**：
1. 产品 → 数据库 → MongoDB云版
2. 创建实例 → 选择配置
3. 设置白名单（添加ECS内网IP）
4. 创建数据库账号

### 1.3 购买Qdrant（可选）

Qdrant有两个选择：
1. **使用云端免费版**（1GB存储）
2. **自建在ECS上**（Docker部署）

推荐使用云端免费版：
- 访问：https://cloud.qdrant.io/
- 注册并创建免费集群

---

## 二、配置ECS服务器

### 2.1 连接服务器

```bash
# SSH连接（使用密码或密钥）
ssh root@your-server-ip

# 或使用阿里云控制台的远程连接
```

### 2.2 基础环境配置

```bash
# 更新系统
apt update && apt upgrade -y

# 安装基础工具
apt install -y git curl wget vim htop net-tools

# 安装Python 3.10
apt install -y software-properties-common
add-apt-repository ppa:deadsnakes/ppa
apt update
apt install -y python3.10 python3.10-venv python3.10-dev

# 安装pip
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
python3.10 get-pip.py

# 设置Python别名（可选）
echo "alias python=python3.10" >> ~/.bashrc
echo "alias pip=pip3.10" >> ~/.bashrc
source ~/.bashrc
```

### 2.3 安装Docker（用于Qdrant）

```bash
# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# 启动Docker
systemctl start docker
systemctl enable docker

# 安装Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
```

### 2.4 部署Qdrant（自建方案）

```bash
# 创建Qdrant数据目录
mkdir -p /data/qdrant

# 运行Qdrant
docker run -d \
  --name qdrant \
  -p 6333:6333 \
  -p 6334:6334 \
  -v /data/qdrant:/qdrant/storage \
  qdrant/qdrant:latest

# 验证运行
curl http://localhost:6333/
```

---

## 三、部署爬虫代码

### 3.1 克隆/上传代码

**方式1：使用Git**
```bash
cd /opt
git clone https://your-repo-url.git shared-cfo
cd shared-cfo
```

**方式2：手动上传**
```bash
# 在本地打包代码
tar -czf shared-cfo.tar.gz shared-cfo/

# 上传到服务器
scp shared-cfo.tar.gz root@your-server-ip:/opt/

# 在服务器上解压
cd /opt
tar -xzf shared-cfo.tar.gz
cd shared-cfo
```

### 3.2 配置Python环境

```bash
# 创建虚拟环境
python3.10 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r crawler/requirements.txt
```

### 3.3 配置环境变量

```bash
# 复制环境变量模板
cp crawler/.env.template crawler/.env

# 编辑环境变量
vi crawler/.env
```

**填写以下关键配置**：
```bash
# MongoDB配置（从阿里云控制台获取）
MONGO_HOST=dds-xxx.mongodb.rds.aliyuncs.com
MONGO_PORT=3717
MONGO_USERNAME=root
MONGO_PASSWORD=YourPassword123
MONGO_DATABASE=shared_cfo

# GLM配置
GLM_API_KEY=your-api-key-here

# 日志配置
LOG_FILE=/opt/shared-cfo/logs/crawler.log
```

### 3.4 创建日志目录

```bash
mkdir -p /opt/shared-cfo/logs
```

---

## 四、测试运行

### 4.1 测试爬虫

```bash
cd /opt/shared-cfo
source venv/bin/activate

# 测试爬取国家税务总局（少量数据）
python -m crawler.run --source chinatax --start-year 2025 --end-year 2025 --limit 5
```

### 4.2 检查数据

```bash
# 进入MongoDB检查
# 使用阿里云DMS或MongoDB Shell连接MongoDB

# 查看数据
use shared_cfo
db.policies.count()
db.policies.findOne()
```

### 4.3 查看日志

```bash
tail -f logs/crawler.log
```

---

## 五、设置定时任务

### 5.1 使用Cron

```bash
# 编辑crontab
crontab -e

# 添加定时任务（每天凌晨2点运行）
0 2 * * * cd /opt/shared-cfo && source venv/bin/activate && python -m crawler.run --source all >> logs/cron.log 2>&1
```

### 5.2 使用Systemd（推荐）

创建服务文件：

```bash
vi /etc/systemd/system/shared-cfo-crawler.service
```

```ini
[Unit]
Description=Shared CFO Tax Policy Crawler
After=network.target

[Service]
Type=oneshot
User=root
WorkingDirectory=/opt/shared-cfo
Environment="PATH=/opt/shared-cfo/venv/bin"
ExecStart=/opt/shared-cfo/venv/bin/python -m crawler.run --source all

[Install]
WantedBy=multi-user.target
```

创建定时器：

```bash
vi /etc/systemd/system/shared-cfo-crawler.timer
```

```ini
[Unit]
Description=Shared CFO Crawler Timer
Requires=shared-cfo-crawler.service

[Timer]
OnCalendar=daily
OnCalendar=02:00
Persistent=true

[Install]
WantedBy=timers.target
```

启用服务：

```bash
systemctl daemon-reload
systemctl enable shared-cfo-crawler.timer
systemctl start shared-cfo-crawler.timer
```

---

## 六、监控和告警

### 6.1 查看服务状态

```bash
# 查看定时器状态
systemctl list-timers

# 查看服务日志
journalctl -u shared-cfo-crawler -f
```

### 6.2 设置磁盘空间告警

```bash
# 创建监控脚本
vi /opt/scripts/check-disk.sh
```

```bash
#!/bin/bash
DISK_USAGE=$(df -h /opt | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "Disk usage is ${DISK_USAGE}%" | mail -s "Alert: High Disk Usage" your@email.com
fi
```

### 6.3 查看MongoDB状态

通过阿里云控制台 → MongoDB → 监控，查看：
- 连接数
- QPS
- 存储空间
- CPU使用率

---

## 七、安全配置

### 7.1 配置防火墙

```bash
# 安装ufw
apt install -y ufw

# 允许SSH
ufw allow 22

# 允许HTTP/HTTPS（如需Web服务）
ufw allow 80
ufw allow 443

# 启用防火墙
ufw enable
```

### 7.2 配置安全组（阿里云）

在阿里云控制台：
1. ECS实例 → 安全组 → 配置规则
2. 添加入方向规则：
   - SSH：22（只允许你的IP）
   - 自定义：6333（Qdrant，只允许内网）
   - MongoDB：3717（只允许内网）

### 7.3 配置SSL/TLS（如需）

```bash
# 安装certbot
apt install -y certbot

# 获取证书
certbot certonly --standalone -d your-domain.com
```

---

## 八、成本优化

### 8.1 入门版月成本

| 资源 | 配置 | 月成本 |
|------|------|--------|
| ECS | 2核4G | ~¥100 |
| MongoDB | 1核2G 100GB | ~¥200 |
| Qdrant | 自建 | ¥0 |
| 带宽 | 1Mbps按量 | ~¥20 |
| GLM API | 100万tokens | ~¥15 |
| **合计** | | **~¥335/月** |

### 8.2 优化建议

1. **按量付费**：适合测试和低频使用
2. **包年包月**：长期使用可节省30-50%
3. **抢占式实例**：可节省80%，但有中断风险
4. **使用OSS存储**：大量附件可使用对象存储

---

## 九、故障排查

### 9.1 爬虫无法连接MongoDB

**检查**：
1. MongoDB白名单是否添加ECS IP
2. 用户名密码是否正确
3. 端口是否正确（通常是3717）

### 9.2 爬虫被403

**解决**：
1. 增加请求延迟（修改.env中的CRAWLER_DELAY_MIN）
2. 检查User-Agent设置
3. 暂停爬取，等待一段时间后重试

### 9.3 数据库空间不足

**解决**：
1. 清理过期数据
2. 升级MongoDB规格
3. 启用数据压缩

---

## 十、后续扩展

### 10.1 添加Web API

```bash
# 安装FastAPI
pip install fastapi uvicorn

# 创建API服务
vi api/main.py
```

### 10.2 添加监控面板

```bash
# 安装Grafana
docker run -d \
  --name grafana \
  -p 3000:3000 \
  grafana/grafana
```

### 10.3 分布式部署

- 使用消息队列（RabbitMQ/Redis）
- 多个ECS实例并行爬取
- 使用Kubernetes管理

---

## 联系支持

如有问题，请检查：
1. 日志文件：`logs/crawler.log`
2. 系统日志：`journalctl -u shared-cfo-crawler`
3. 阿里云控制台监控
